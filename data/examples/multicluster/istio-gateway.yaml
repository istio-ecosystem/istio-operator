apiVersion: install.istio.io/v1alpha2
kind: IstioControlPlane
spec:
  hub: gcr.io/istio-testing
  tag: 1.4-dev
  defaultNamespace: istio-system
  trafficManagement:
    enabled: false

  policy:
    enabled: false

  telemetry:
    enabled: false

  security:
    enabled: false

  configManagement:
    enabled: false

  autoInjection:
    enabled: false

  gateways:
    enabled: true

  values:
    global:
      omitSidecarInjectorConfigMap: true
      useMCP: false
      proxy:
        envoyStatsd:
          enabled: false
          host:
          port:

    pilot:
      sidecar: false

    prometheus:
      enabled: false

  unvalidatedValues:
    gateways:
      custom-gateway:
        enabled: true
        labels:
          app: custom-gateway
        replicaCount: 1
        autoscaleMin: 1
        autoscaleMax: 5
        resources: {}
        cpu:
          targetAverageUtilization: 80
        loadBalancerIP: ""
        loadBalancerSourceRanges: {}
        externalIPs: []
        serviceAnnotations: {}
        podAnnotations: {}
        type: LoadBalancer #change to NodePort, ClusterIP or LoadBalancer if need be
        #externalTrafficPolicy: Local #change to Local to preserve source IP or Cluster for default behaviour or leave commented out
        ports:
          ## You can add custom gateway ports
          - port: 80
            targetPort: 80
            name: http2
            # nodePort: 31380
          - port: 443
            name: https
            # nodePort: 31390
          - port: 31400
            name: tcp
            # nodePort: 31400
          # Pilot and Citadel MTLS ports are enabled in gateway - but will only redirect
          # to pilot/citadel if global.meshExpansion settings are enabled.
          - port: 15011
            targetPort: 15011
            name: tcp-pilot-grpc-tls
          - port: 8060
            targetPort: 8060
            name: tcp-citadel-grpc-tls
          # Addon ports for kiali are enabled in gateway - but will only redirect if
          # the gateway configuration for the various components are enabled.
          - port: 15029
            targetPort: 15029
            name: http2-kiali
          # Telemetry-related ports are enabled in gateway - but will only redirect if
          # the gateway configuration for the various components are enabled.
          - port: 15030
            targetPort: 15030
            name: http2-prometheus
          - port: 15031
            targetPort: 15031
            name: http2-grafana
          - port: 15032
            targetPort: 15032
            name: http2-tracing
        secretVolumes:
          - name: customgateway-certs
            secretName: istio-customgateway-certs
            mountPath: /etc/istio/customgateway-certs
          - name: customgateway-ca-certs
            secretName: istio-customgateway-ca-certs
            mountPath: /etc/istio/customgateway-ca-certs


